#!/usr/bin/env bash
set -euo pipefail

# Generate .env with host docker group GID
echo "DOCKER_GID=$(stat -c '%g' /var/run/docker.sock)" > .env

# Try GPU first, fall back to CPU if nvidia runtime fails
if docker info 2>/dev/null | grep -q "nvidia"; then
    echo "GPU runtime detected — trying GPU support..."
    if docker compose -f docker-compose.yml -f docker-compose.gpu.yml up -d "$@" 2>&1; then
        echo "Started with GPU support"
    else
        echo "GPU failed (driver issue?) — falling back to CPU"
        docker compose down 2>/dev/null || true
        docker compose up -d "$@"
    fi
else
    echo "GPU not detected — starting with CPU"
    docker compose up -d "$@"
fi
